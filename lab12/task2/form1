using System;
using System.Windows.Forms;

namespace OrderPipeline
{
    public partial class Form1 : Form
    {
        //events fortask1
        public event EventHandler<ShipEventArgs> OrderCreated;
        public event EventHandler OrderRejected;
        public event EventHandler<string> OrderConfirmed;

        //events for task2
        public event EventHandler<ShipEventArgs> OrderShipped;

        //boolean to check if orderconfirmed earlier or not
        private bool orderConfirmed = false;

        public Form1()
        {
            InitializeComponent();

            //subscribers of task1
            OrderCreated += ValidateOrder;
            OrderCreated += DisplayOrderInfo;

            OrderRejected += ShowRejection;
            OrderConfirmed += ShowConfirmation;

            //subscribers of task2
            OrderShipped += ShowDispatch;
            //NotifyCourier will be added dynamically
        }

        private void Form1_Load(object sender, EventArgs e)
        {

        }


        private void btnProcessOrder_Click(object sender, EventArgs e)
        {
            string customer = txtCustomer.Text;
            string product = comboBox1.SelectedItem?.ToString();
            int quantity = (int)numericUpDown1.Value;

            ShipEventArgs args = new ShipEventArgs(product, false); //express not used here

            OrderCreated?.Invoke(this, args);
        }

        private void ValidateOrder(object? sender, ShipEventArgs e)
        {
            int quantity = (int)numericUpDown1.Value;

            if (quantity <= 0)
            {
                orderConfirmed = false;
                OrderRejected?.Invoke(this, EventArgs.Empty);
                return;
            }

            lblStatus.Text = "Validated";

            orderConfirmed = true;

            string customer = txtCustomer.Text;
            OrderConfirmed?.Invoke(this, customer);
        }

        private void DisplayOrderInfo(object sender, ShipEventArgs e)
        {
            MessageBox.Show($"Product: {e.Product}\nExpress: {e.Express}");
        }

        private void ShowRejection(object? sender, EventArgs e)
        {
            lblStatus.Text = "Order Invalid â€“ Please retry";
        }

        private void ShowConfirmation(object? sender, string customer)
        {
            lblStatus.Text = $"Order Processed Successfully for {customer}";
        }


        private void btnShipOrder_Click(object sender, EventArgs e)
        {
            if (!orderConfirmed)
            {
                MessageBox.Show("Order not confirmed yet!");
                return;
            }

            string product = comboBox1.SelectedItem?.ToString() ?? "Unknown";
            bool express = chkExpress.Checked;

            ShipEventArgs shipArgs = new ShipEventArgs(product, express);

            if (express)
            {
                OrderShipped += NotifyCourier;
                lblSubscriberStatus.Text = "NotifyCourier: SUBSCRIBED";
            }
            else
            {
                OrderShipped -= NotifyCourier;
                lblSubscriberStatus.Text = "NotifyCourier: UNSUBSCRIBED";
            }
            // Fire shipping event
            OrderShipped?.Invoke(this, shipArgs);
        }

        private void ShowDispatch(object? sender, ShipEventArgs e)
        {
            lblStatus.Text = $"Product dispatched: {e.Product}";
        }

        private void NotifyCourier(object? sender, ShipEventArgs e)
        {
            if (e.Express)
                MessageBox.Show("Express delivery initiated!");
        }
    }

    public class ShipEventArgs : EventArgs
    {
        public string Product { get; }
        public bool Express { get; }

        public ShipEventArgs(string p, bool ex)
        {
            Product = p;
            Express = ex;
        }
    }
}
